<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุชุณุฌูู ุญุถูุฑ ูุญุงุถุฑุงุช ููุฏููู ุงูุฃุทูุงู</title>
  <link rel="stylesheet" href="styles.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet"/>
  <style>
    :root { --app-font: "Cairo", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    html, body { font-family: var(--app-font); }
  </style>
</head>

<body>

<header class="site-header">
  <h1>ุชุณุฌูู ุญุถูุฑ ูุญุงุถุฑุงุช ุงูุฃุทูุงู ุฌุฑูุจ B ุฃูู 3 ุฃุณุงุจูุน</h1>
  <p class="sub">ุงูุชุจ ุงุณูู ูุฑูู ุฌููุณู ูุงุฎุชุฑ ููู ุงูุญุถูุฑ. ุงูุฃูุงูู ูุญุฏูุฏุฉ ููู ุฑุบุจุฉ.</p>
</header>

<main class="grid">
  <section class="card">
    <h2 class="card-title">ุจูุงูุงุช ุงูุทุงูุจ</h2>
    <form class="form" id="pref-form">
      <label for="name">ุงูุงุณู ุฑุจุงุนู (ุจุงููุบุฉ ุงูุนุฑุจูุฉ)</label>
      <input id="name" name="name" type="text" required autocomplete="off"/>

      <label for="seat">ุฑูู ุงูุฌููุณ (ุจุงููุบุฉ ุงูุฅูุฌููุฒูุฉ)</label>
      <input id="seat" name="seat" type="text" required inputmode="numeric" placeholder="ูุซุงู: 1234"/>

      <label for="choice">ุงูุฑุบุจุฉ</label>
      <select id="choice" name="choice" required>
        <option value="" selected disabled>ุงุฎุชุฑ ุฑุบุจุชู</option>
      </select>

      <button class="btn-primary" id="submitBtn" type="submit">ุชุณุฌูู ุงูุฑุบุจุฉ</button>
      <button class="btn-ghost" id="checkOpen" type="button">๐งฉ ุงุฎุชุจุงุฑ ุงูุชุณุฌูู (ุงูุฑุบุจุฉ ูุงูุญุถูุฑ)</button>
    </form>
    <div id="status" class="status" aria-live="polite"></div>
  </section>

  <section class="card">
    <h2 class="card-title">ุฅุญุตุงุฆูุงุช ูุจุงุดุฑุฉ</h2>
    <div id="stats" class="stats"></div>
  </section>

  <section class="card">
    <h2 class="card-title">ููุญุฉ ุงููุดุฑููู</h2>
    <button class="btn-ghost" id="adminOpen">ุชุณุฌูู ุงูุญุถูุฑ (ููุฃุฏูู)</button>
    <p class="muted">ุฎุงุต ุจุงููุณุคูููู ููุท.</p>
  </section>
</main>

<!-- ูุงูุฐุฉ ุงุฎุชุจุงุฑ ุงูุชุณุฌูู -->
<dialog class="dialog" id="checkDialog">
  <form class="dialog-card" id="checkForm" method="dialog">
    <h3>ุงุฎุชุจุงุฑ ุงูุชุณุฌูู</h3>
    <label>ุฑูู ุงูุฌููุณ</label>
    <input id="checkSeat" required inputmode="numeric" placeholder="ูุซุงู: 1234"/>
    <menu class="dialog-actions">
      <button class="btn-ghost" value="cancel">ุฅุบูุงู</button>
      <button class="btn-primary" id="checkBtn" value="check">ุนุฑุถ ุงูุจูุงูุงุช</button>
    </menu>
    <div id="checkResult" class="status"></div>
  </form>
</dialog>

<!-- ูุงูุฐุฉ ุงูุฃุฏูู ูุงููุฉ -->
<dialog class="dialog" id="adminDialog">
  <form class="dialog-card" id="adminLoginForm" method="dialog">
    <h3>ุชุณุฌูู ุฏุฎูู ุงููุดุฑู</h3>
    <label>ุงุณู ุงููุณุชุฎุฏู</label>
    <input id="adminUser" autocomplete="username" required/>
    <label>ูููุฉ ุงูุณุฑ</label>
    <input id="adminPass" type="password" autocomplete="current-password" required/>
    <menu class="dialog-actions">
      <button class="btn-ghost" value="cancel">ุฅูุบุงุก</button>
      <button class="btn-primary" id="adminLoginBtn" value="login">ุฏุฎูู</button>
    </menu>
    <div id="adminLoginMsg" class="status"></div>
  </form>

  <form class="dialog-card" id="adminPanel" hidden method="dialog">
    <h3>ุชุณุฌูู ุงูุญุถูุฑ</h3>

    <!-- ุณูุจุฑ ุฃุฏูู: ุฅุฏุงุฑุฉ ุงูุฃูุงู ูุงูุณุนุงุช -->
    <section id="superAdminConfig" class="card" hidden>
      <h4 class="card-title">ุฅุฏุงุฑุฉ ุงูุฃูุงู ูุงูุณุนุงุช (ุณูุจุฑ ุฃุฏูู)</h4>
      <div class="super-form-row" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
        <input id="choiceNameInput" placeholder="ุงุณู ุงูููู / ุงูุฑุบุจุฉ ุงูุฌุฏูุฏุฉ" style="flex:2;min-width:160px;"/>
        <input id="choiceCapacityInput" type="number" min="0" placeholder="ุงูุณุนุฉ ุงููููุฉ" style="flex:1;min-width:120px;"/>
        <button class="btn-primary" id="addChoiceBtn" type="button">ุฅุถุงูุฉ / ุชุญุฏูุซ</button>
      </div>
      <div id="choicesList" class="table"></div>
      <p class="muted" style="margin-top:6px;">ููููู ุชุนุฏูู ุงูุณุนุฉ ูุฃู ูููุ ุฃู ุฅุถุงูุฉ ููู ุฌุฏูุฏ.</p>
    </section>

    <!-- ุณูุจุฑ ุฃุฏูู: ุชูุงุฑูุฑ ุงูุญุถูุฑ -->
    <section id="superAdminReports" class="card" hidden>
      <h4 class="card-title">ุชูุงุฑูุฑ ุงูุญุถูุฑ</h4>
      <div class="toolbar">
        <select id="reportChoiceFilter">
          <option value="">ูู ุงูุฃูุงู</option>
        </select>
        <button class="btn-ghost" id="loadReportsBtn" type="button">ุชุญุฏูุซ ุงูุชูุงุฑูุฑ</button>
      </div>

      <div class="report-wrapper"
           style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:8px;">
        <div>
          <h5 style="margin:4px 0;">ุญุถุฑูุง</h5>
          <div id="reportAttendedTable" class="table"></div>
        </div>
        <div>
          <h5 style="margin:4px 0;">ูุณุฌููู ููู ูุญุถุฑูุง</h5>
          <div id="reportAbsentTable" class="table"></div>
        </div>
      </div>
    </section>

    <!-- ุฃุฏูุงุช ุงูุฃุฏูู -->
    <div class="toolbar">
      <input id="searchInput" placeholder="ุงุจุญุซ ุจุงูุงุณู ุฃู ุฑูู ุงูุฌููุณ"/>
      <input id="attDate" type="hidden"/>
      <button class="btn-ghost" id="refreshSubs" type="button">ุชุญุฏูุซ ุงููุงุฆูุฉ</button>
    </div>

    <div id="subsTable" class="table"></div>

    <menu class="dialog-actions">
      <button class="btn-ghost" value="close">ุฅุบูุงู</button>
      <button class="btn-primary" id="saveAttendance" type="button">ุชุณุฌูู ุงูุญุถูุฑ</button>
    </menu>
    <div id="adminMsg" class="status"></div>
  </form>
</dialog>

<footer class="site-footer">
  <a href="https://t.me/Dr_Ahmed_Eisa" target="_blank" rel="noopener noreferrer">
    Developer: Dr_Ahmed_Eisa
  </a>
</footer>

<!-- ุงูููุฏ ููู ุดุบุงู ูุน Firebase ูู ุฏุงุฎู script.js -->
<script type="module" src="script.js"></script>

<script>
  // ุถุจุท ููุช ุงูุญุถูุฑ + ููุชุฑ ุฌุฏูู ุงูุฑุบุจุงุช ููุฃุฏูู
  (function () {
    const attDate = document.getElementById('attDate');
    const subsTable = document.getElementById('subsTable');

    function setNow() {
      try {
        const now = new Date();
        if (attDate) attDate.value = now.toISOString();
      } catch (e) {}
    }

    function ensureHeaderFilter() {
      if (!subsTable) return;
      const head = subsTable.querySelector('.row.head');
      if (!head) return;

      if (head.querySelector('.pref-filter')) return;

      const cells = head.querySelectorAll('.cell');
      if (cells.length < 4) return;

      const prefHead = cells[3];
      const select = document.createElement('select');
      select.className = 'pref-filter';
      select.innerHTML = `<option value="">ูู ุงูุฑุบุจุงุช</option>`;

      const rows = Array.from(subsTable.querySelectorAll('.row'))
        .filter(r => !r.classList.contains('head'));

      const prefs = new Set();
      rows.forEach(r => {
        const c = r.querySelectorAll('.cell')[3];
        if (c) prefs.add(c.textContent.trim());
      });

      prefs.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        select.appendChild(opt);
      });

      select.addEventListener('change', () => {
        const wanted = select.value;
        const rows2 = Array.from(subsTable.querySelectorAll('.row'))
          .filter(r => !r.classList.contains('head'));
        rows2.forEach(r => {
          const cells2 = r.querySelectorAll('.cell');
          const val = (cells2[3] ? cells2[3].textContent : '').trim();
          const show = !wanted || val === wanted;
          r.style.display = show ? '' : 'none';
        });
      });

      prefHead.textContent = '';
      prefHead.appendChild(select);
    }

    const mo = new MutationObserver(() => {
      requestAnimationFrame(ensureHeaderFilter);
    });
    if (subsTable) mo.observe(subsTable, { childList: true, subtree: true });

    window.addEventListener('DOMContentLoaded', () => {
      setNow();
      ensureHeaderFilter();
    });
  })();
</script>

</body>
</html>
